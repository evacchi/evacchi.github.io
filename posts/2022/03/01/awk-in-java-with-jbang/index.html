<!doctype html><html lang=en-us><head><title>AWK in Java with JBang! | Middle of Nowhere</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="A few days ago I learned about pz. A Python library that exposes a few simple one-letter shorthands for line-based editing of pipes at the command-line. I immediately thought there could be potential.
This is simple and clever. The default `s` variable holds the contents of stdin. @jbangdev idea? ü§îhttps://t.co/pBBcIfEIJb
&mdash; Edoardo Vacchi (@evacchi) February 12, 2022 I liked the idea so I pestered Max Andersen: what if JBang supported that kind of shorthand syntax?"><meta name=generator content="Hugo 0.116.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/images/favicon.ico type=image/x-icon><script async src="https://www.googletagmanager.com/gtag/js?id=G-JEBNMYFPPB"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JEBNMYFPPB")</script></head><body><nav class=navigation><a href=/><span class=arrow>‚Üê</span>Home</a>
<a href=/posts>Archive</a>
<a href=/tags>Tags</a>
<a href=/about>About</a></nav><main class=main><section id=single><h1 class=title>AWK in Java with JBang!</h1><div class=tip><time datetime="2022-03-01 00:00:00 +0000 UTC">Mar 1, 2022</time>
<span class=split>¬∑</span>
<span>815 words</span>
<span class=split>¬∑</span>
<span>4 minute read</span></div><div class=content><p>A few days ago I learned about <a href=https://github.com/CZ-NIC/pz target=_blank rel=noopener><code>pz</code></a>. A Python library that exposes a few simple one-letter shorthands for line-based editing of pipes at the command-line. I immediately thought there could be potential.</p><blockquote class=twitter-tweet><p lang=en dir=ltr>This is simple and clever. The default `s` variable holds the contents of stdin. <a href="https://twitter.com/jbangdev?ref_src=twsrc%5Etfw">@jbangdev</a> idea? ü§î<a href=https://t.co/pBBcIfEIJb>https://t.co/pBBcIfEIJb</a></p>&mdash; Edoardo Vacchi (@evacchi) <a href="https://twitter.com/evacchi/status/1492559555292766219?ref_src=twsrc%5Etfw">February 12, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>I liked the idea so I pestered <a href=https://twitter.com/maxandersen target=_blank rel=noopener>Max Andersen</a>: what if <a href=https://jbang.dev target=_blank rel=noopener>JBang</a> supported that kind of shorthand syntax? It turned out Max was already working on something:</p><blockquote class=twitter-tweet><p lang=en dir=ltr>This might be possible sooner than I thought it would be.<a href=https://t.co/nO4CHgQenV>pic.twitter.com/nO4CHgQenV</a></p>&mdash; Max Rydahl Andersen (@maxandersen) <a href="https://twitter.com/maxandersen/status/1489214081127043075?ref_src=twsrc%5Etfw">February 3, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>This is already available since <a href=https://github.com/jbangdev/jbang/releases/tag/v0.90.0 target=_blank rel=noopener>JBang 0.90.0</a> (but you should use <a href=https://github.com/jbangdev/jbang/releases/tag/v0.90.1 target=_blank rel=noopener>v0.90.1</a>).</p><p>I was pretty sure that this new feature could be used to implement AWK-like scripting using Java:</p><blockquote class=twitter-tweet><p lang=en dir=ltr>This+data frame lib = jawk !</p>&mdash; Edoardo Vacchi (@evacchi) <a href="https://twitter.com/evacchi/status/1494603353468383234?ref_src=twsrc%5Etfw">February 18, 2022</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>For the following days I have been playing around with a short <code>Prelude</code> to enhance these kind of one-liners on JBang. But today I came across a <a href=https://benhoyt.com/writings/prig/ target=_blank rel=noopener>blog post about Prig</a> on <a href="https://news.ycombinator.com/item?id=30498735" target=_blank rel=noopener>Hacker News</a>. Prig is <a href=https://benhoyt.com/writings/prig/ target=_blank rel=noopener>¬´like AWK, but uses Go for ‚Äúscripting‚Äù¬ª</a>.</p><p>Well, that did it. I had to show I could do the same with JBang. I give you: <a href=https://gist.githubusercontent.com/evacchi/7fb37056d92f72ae88157adcbb2f6bea/raw/8cdef074fe8184e8ed964c177c5cb835c863d1d5/Prelude.jsh target=_blank rel=noopener><code>Prelude.jsh</code></a></p><p>It is a very short collections of utilities. The main idea is that the class <code>Line</code> may be used to split the fields of a stdin line into an AWK-like &ldquo;record&rdquo;. I didn&rsquo;t call it <code>record</code> not to confuse it with Java 16+&rsquo;s <code>record</code> feature.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#00f>class</span> <span style=color:#2b91af>Line</span> {
</span></span><span style=display:flex><span>    <span style=color:#00f>private</span> <span style=color:#00f>final</span> String line;
</span></span><span style=display:flex><span>    <span style=color:#00f>private</span> <span style=color:#00f>final</span> String pattern;
</span></span><span style=display:flex><span>    <span style=color:#00f>private</span> <span style=color:#00f>final</span> String[] fields; 
</span></span><span style=display:flex><span>    <span style=color:#00f>public</span> <span style=color:#00f>final</span> <span style=color:#2b91af>int</span> nf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Line(String line_, String pattern) {
</span></span><span style=display:flex><span>        line = line_; fields = line.split(pattern); 
</span></span><span style=display:flex><span>        nf = fields.length == 1 ? 0 : fields.length;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    Line(String line) { <span style=color:#00f>this</span>(line, <span style=color:#a31515>&#34;\\s+&#34;</span>); }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00f>public</span> String s(<span style=color:#2b91af>int</span> n) { <span style=color:#00f>return</span> (n == 0)? line : fields[n-1]; }
</span></span><span style=display:flex><span>    <span style=color:#00f>public</span> <span style=color:#2b91af>int</span> i(<span style=color:#2b91af>int</span> n) { <span style=color:#00f>return</span> Integer.parseInt(s(n)); }
</span></span><span style=display:flex><span>    <span style=color:#00f>public</span> <span style=color:#2b91af>double</span> d(<span style=color:#2b91af>int</span> n) { <span style=color:#00f>return</span> Double.parseDouble(s(n)); }
</span></span><span style=display:flex><span>    <span style=color:#00f>public</span> String toString() { <span style=color:#00f>return</span> line; }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>All it does is splitting a line into whitespace-separated fields. You can access a field with
<code>Line#s</code>. At index <code>0</code> you&rsquo;ll find the entire line; at 1..n you&rsquo;ll find the first..n-th field.</p><p><code>Line#d</code>, <code>Line#i</code>, are just shorthands to convert the n-th field to a double or an integer.</p><p><code>Line#nf</code> gives you the number of fields, just like <code>AWK</code>&rsquo;s <code>$NF</code>.</p><p>There you go. Now suppose you want to print the second field for each line in <code>logs.txt</code></p><pre tabindex=0><code>$ cat logs.txt
GET /robots.txt HTTP/1.1
HEAD /README.md HTTP/1.1
GET /wp-admin/ HTTP/1.0
</code></pre><p>You would write:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cat logs.txt | jbang -s Prelude.jsh -c <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    <span style=color:#a31515>&#39;lines().map(Line::new).map(l -&gt; l.s(2)).forEach(s -&gt; println(s))&#39;</span>
</span></span></code></pre></div><p>of course, you&rsquo;ll need to first download <code>Prelude.jsh</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl -L https://bit.ly/prelude-jsh -o Prelude.jsh
</span></span></code></pre></div><p>oh, by the way, since JBang is awesome, you can also write:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cat logs.txt | jbang -s https://bit.ly/prelude-jsh -c <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    <span style=color:#a31515>&#39;lines().map(Line::new).map(l -&gt; l.s(2)).forEach(s -&gt; println(s))&#39;</span>
</span></span></code></pre></div><blockquote><p>üö® <strong>Update:</strong> JBang v0.91.0 has become even <em>awesomer</em>: you can now skip the download and use the <a href=https://github.com/evacchi/jbang-catalog target=_blank rel=noopener>catalog I posted here</a></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cat logs.txt | jbang -s prelude@evacchi -c <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    <span style=color:#a31515>&#39;lines().map(Line::new).map(l -&gt; l.s(2)).forEach(s -&gt; println(s))&#39;</span>
</span></span></code></pre></div></blockquote><p>Now, because creating a <code>Line</code> object, then mapping it and then printing each result is so frequent, I also defined a few shorthands for you:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Stream&lt;Line&gt; $lines() { <span style=color:#00f>return</span> lines().map(Line::<span style=color:#00f>new</span>); }
</span></span><span style=display:flex><span><span style=color:#2b91af>void</span> $$(Function&lt;Line, Object&gt; f) { $lines().map(f).forEach(o -&gt; println(o)); }
</span></span></code></pre></div><p>There you go, now you can write:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cat logs.txt | jbang -s Prelude.jsh -c <span style=color:#a31515>&#39;$$(l -&gt; l.s(2))&#39;</span>
</span></span></code></pre></div><p>and of course, now we can implement the example found in the <a href=https://benhoyt.com/writings/prig/ target=_blank rel=noopener>Prig blog post</a></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cat logs.txt | jbang -s Prelude.jsh -c <span style=color:#a31515>&#39;$$(l -&gt; &#34;https://example.com&#34; + l.s(2))&#39;</span>
</span></span></code></pre></div><p>But let&rsquo;s see how we may implement the other examples as well.</p><p>The average of the third column in <code>average.txt</code>:</p><pre tabindex=0><code>$ cat average.txt
a b 400
c d 200
e f 200
g h 200
</code></pre><p>would be:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cat average.txt | jbang -s Prelude.jsh -c <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    <span style=color:#a31515>&#39;$lines().mapToInt(l -&gt; l.i(l.nf)).average().ifPresent(d -&gt; println(d))&#39;</span>
</span></span></code></pre></div><p>Format into millis the third row in <code>millis.txt</code></p><pre tabindex=0><code>$ cat millis.txt
1 GET 3.14159
2 HEAD 4.0
3 GET 1.0
</code></pre><p>is just:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cat millis.txt | jbang -s Prelude.jsh -c <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    <span style=color:#a31515>&#39;$lines().filter(l -&gt; l.s(0).matches(&#34;.*(GET|HEAD).*&#34;))
</span></span></span><span style=display:flex><span><span style=color:#a31515>        .forEach(l -&gt; printf(&#34;%.0fms\n&#34;, l.d(3)*1000))&#39;</span>
</span></span></code></pre></div><p>This is only slightly more cumbersome because <code>String#matches</code> matches against the entire line; hence requiring the leading <code>.*(</code> and the trailing <code>).*</code> in the pattern. You may easily add a shorthand to <code>Line</code> to decorate the pattern and avoid the noise.</p><p>e.g.:</p><pre tabindex=0><code>boolean matches(int n, String pattern) { return s(n).matches(&#34;.*&#34; + pattern + &#34;.*&#34;); }
</code></pre><p>Finally, counting word frequency in <code>words.txt</code></p><pre tabindex=0><code>$ cat words.txt 
The foo barfs
foo the the the
</code></pre><p>In fact, this does not even require the <code>Prelude</code> !</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ cat words.txt | jbang -c <span style=color:#a31515>\
</span></span></span><span style=display:flex><span><span style=color:#a31515></span>    <span style=color:#a31515>&#39;println(lines().flatMap(s -&gt; Stream.of(s.split(&#34;\s+&#34;)))
</span></span></span><span style=display:flex><span><span style=color:#a31515>        .collect(Collectors.groupingBy(Function.identity(), Collectors.counting())))&#39;</span>
</span></span></code></pre></div><p>The JBang line-editing feature does not stop here. You have all JBang&rsquo;s power at your fingertips: you can declare dependencies, extend the prelude further&mldr; have fun!</p><p>Thanks to <a href=https://benhoyt.com/writings/prig/ target=_blank rel=noopener>Ben Hoyt</a> for nerd-sniping me!</p></div><div class=tags><a href=/tags/awk>AWK</a>
<a href=/tags/jbang>JBang</a></div></section></main><footer id=footer><div class=social><a class="symbol github" href=https://github.com/evacchi rel=me target=_blank></a><a class="symbol linkedin" href=https://linkedin.com/in/edoardovacchi rel=me target=_blank></a><a class="symbol mastodon" href=https://mastodon.social/@evacchi rel=me target=_blank></a><a class="symbol twitter" href=https://twitter.com/evacchi rel=me target=_blank></a></div><div class=copyright>¬© Copyright
2023
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span>Edoardo Vacchi</div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>